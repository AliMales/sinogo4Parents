<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/common.css"/>
    <style>
    	html,body{
    		height:100%;
    	}
    	#main{
    		height:100%;
    	}
    	#guide{
    		position:fixed;
			top: 0;
    	}
    	#recent{
    		height:0.88rem;
    		background:url(../../image/icon_arrow_right.png) no-repeat right 0.23rem center #FFF;
    		background-size:0.16rem 0.28rem;
    		position: relative;
    	}
    	#recent:after{
    		border-bottom:1px solid #c1c1c1;
    		position: absolute;
    		top:0.88rem;
			right: 0;
			bottom: 0;
			left: 0;
    		display: block;
    		content:'';
    		pointer-events:none;
    		transform-origin: 0 0;
    		transform: scaleY(0.5);
    		-webkit-transform-origin: 0 0;
    		-webkit-transform: scaleY(0.5);
    	}
    	#recent a{
    		font-size:0.24rem;
    		color:#adacac;
    		float:left;
    		width: 6.8rem;
    		height:0.88rem;
    		line-height:0.88rem;
    		background:url(../../image/icon_history.png) no-repeat left 0.23rem center;
    		background-size:0.28rem 0.28rem;
    		padding-left:0.7rem;
    	}
    	#recent a.active{
    		background:url(../../image/icon_history.png) no-repeat left 0.23rem center rgba(0,0,0,0.1);
    		background-size:0.28rem 0.28rem;
    	}
    	#history{
    		width:100%;
    		background:#FFF;
    	}
    	#history #history_title{
    		height:0.88rem;
    		margin-left:0.23rem;
    		margin-right:0.23rem;
    		background:url(../../image/icon_arrow_down.png) no-repeat right center;
    		background-size:0.28rem 0.16rem;
    		position: relative;
    	}
    	#history #history_title:after{
    		border-bottom:1px solid #E1E1E1;
    		position: absolute;
			right: 0;
			bottom: 0;
			left: 0;
    		display: block;
    		content:'';
    		pointer-events:none;
    		-webkit-transform-origin: 0 0;
    		-webkit-transform: scaleY(0.5);
    	}
    	#history #history_title span{
    		font-size:0.24rem;
    		color:#adacac;
    		float:left;
    		height:0.88rem;
    		line-height:0.88rem;
    		background:url(../../image/icon_search_light.png) no-repeat left center;
    		background-size:0.26rem 0.26rem;
    		padding-left:0.47rem;
    	}
    	
    	#history #history_content div{
    		font-size:0.24rem;
    		margin-left:0.23rem;
    		margin-right:0.23rem;
    		color:#777777;
    		height:0.88rem;
    		line-height:0.88rem;
    		position: relative;
    	}
    	#history #history_content div:after{
    		border-bottom:1px solid #E1E1E1;
    		position: absolute;
			right: 0;
			bottom: 0;
			left: 0;
    		display: block;
    		content:'';
    		pointer-events:none;
    		-webkit-transform-origin: 0 0;
    		-webkit-transform: scaleY(0.5);
    	}
    	#history #history_content div a{
    		width: 6.55rem;
    		height:100%;
    		padding-left:0.5rem;
    		background:#FFF;
    	}
    	#history #history_content div a.active{
    		background:#F9F9F9 !important;
    	}
    	
    	#discover_content .listview {
				height: 3.1rem;
			}
			.listview a {
				height:2.4rem;
				width: 100%;
				position :relative;
				background:#FFF;
			}
			.listview a.active {
				background:#F9F9F9 !important;
			}
			.listview .price{
				height:0.7rem;
				line-height:0.7rem;
				text-align: center;
				font-size:0.32rem;
				background:#FFF;
				color:#FF8344;
				position:relative;
			}
			.listview .price:before{
				position:absolute;
				border-top:dashed 1px #e6e6e6;
				top:0;left:0;right:0;
				content:"";display:block;
				-webkit-transform:scaleY(0.5);
				-webkit-transform-origin: 0 0;
			}
			.listview .price img{
				width:0.26rem;
				height:0.26rem;
			}
			.listview .price .pricespan{
				margin-left:0.1rem;
			}
			#discover_content .pic {
				width: 2.12rem;
				height: 1.6rem;
				margin-left:0.24rem;
				margin-top:0.39rem;
				float:left;
			}
			#discover_content #right {
				display: inline-block;
				margin-left:0.42rem;
				margin-top:0.4rem;
				height:1.62rem;
				width:4.7rem;
			}
			#right .h2{
				font-size:0.28rem;
				color:#333333;
			}
			#right > div{
				font-size:0.22rem;
				color:#666666;
				margin-top:0.1rem;
			}
			#right .double{
				width:3rem;
				height: 0.32rem;
				line-height: 0.32rem;
			}
			#right .double img{
				width:0.24rem;
				height: 0.24rem;
				margin-right:0.1rem;
			}
			.starcontent{
				display: inline-block;
				padding: 0;
				margin: 0;
			}
			.starcontent .star{
				max-width:0.24rem;
				max-height:0.24rem;	
				width:0.24rem;
				height:0.24rem;
				float: left;
				margin-left: 0.06rem;
			}
			#right .ellipsis-1{
				display: -webkit-box;
				-webkit-line-clamp: 1;
				-webkit-box-orient: vertical;
				overflow: hidden;
				text-overflow: ellipsis;
				word-wrap: break-word;
				white-space: normal !important;
				height: 0.32rem;
			}
			#right .imp{
				color:#F48844;
			}
			.listview{
				position: relative;
				/*border-bottom: 0.01rem solid #CCCCCC;*/
			}
			.listview:after {
				border-bottom: 1px solid #c8c7cc;
				display: block;
				content: '';
				position: absolute;
				bottom: 0;
				right: 0;
				bottom: 0;
				left: 0;
				-webkit-transform-origin: 0 0;
				-webkit-transform: scaleY(0.5);
				pointer-events: none;
			}
		#empty{
			width:100%;
			height:100%;
			text-align: center;
		}
		#empty .errnet{
			height:30%;
			background:url(../../image/icon_net_err.png) no-repeat center bottom ;
			background-size:2.5rem 2.5rem;
		}
		#empty label{
			margin-top:0.5rem;
			color:#666666;
			font-size:0.34rem;
		}
		#empty .try{
			margin:0.3rem auto;
			width:1.8rem;
			height:0.6rem;
			color: #1A9973;
			font-size:0.34rem;
			line-height:0.6rem;
		}
    </style>
</head>
<body>
	<div id="main">
		<script type="text/x-dot-template" id="discover_template">
			{{ for(var i=0;i<it.length;i++){ }}
				<div class="listview">
					<a tapmode="active" onclick="goDetail({{=i}},'{{=it[i].classId}}','{{=it[i].courseId}}')"> <img class="pic" src="{{=($api.imageUrl+it[i].courseImg)}}" onerror="onImgError(this)" alt="" />
						<div id="right">
							<div class="h2 ellipsis-2"><strong>{{=it[i].courseName}} {{=it[i].className}}</strong></div>
							<div>
								<span class="double">
									{{var length=it[i].score; if(!isInteger(length)){length=parseInt(length)} }}
									{{ for(var j=0;j<length;j++){ }}
										<img src="../../image/icon_star_whole.png" />
									{{ } }}
									{{ var length=it[i].score; if(!isInteger(length)){ }}
									<img src="../../image/icon_star_half.png" />
									{{ } }}
									&nbsp;&nbsp;<span class="imp">{{=it[i].score}}分</span>
								</span>
								已有: <span class="imp" >{{=it[i].registeredPeopers}}</span>人报名
							</div>
							<div>
								<span class="double">{{=it[i].teachingInstitutionName}}</span>
								距离:<span>{{=(it[i].distance||it[i].distance==0)?it[i].distance:''}}KM</span>
							</div>
						</div> 
					</a>
					<div class="price">
					<img src="../../image/icon_course_price.png" alt="" />
					<span class="pricespan">{{=it[i].coursePrice}}</span>
					</div>
				</div>
			{{ } }}
		</script>
		<div id="discover_content">
		</div>
		<div id="guide">
			<div id="recent">
				<a tapmode='active'>最近浏览</a>
			</div>
			<script id="history_template" type="text/x-dot-template">
				{{ for(var i=0;i<it.length;i++){ }}
					<div ><a  tapmode="active" onclick="searchByKey('{{=it[i]}}');">{{=it[i]}}</a></div>
				{{ } }}
			</script>
			<div id="history">
				<div id="history_title">
					<span>历史搜索</span>
				</div>
				<div id="history_content">
				</div>
			</div>
		</div>
	</div>
	<div id="empty" style="display:none">
		<div class="errnet"></div>
		<label class="errmsg">网络连接异常</label>
		<div class="try" onclick="tryAgain()">再试一次</div>
	</div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/common.js"></script>
<script type="text/javascript" src="../../script/doT.js"></script>
<script type="text/javascript">
	imready = function(){
//		var a = ""
//		alert(a.split(",").length)
//		api.setPrefs({
//	        key:'discover_search_history',
//	        value:''
//      });
		window.key=''
		initHistory();
	};
	
	function handleGuide(s){
		if(s){
			initHistory()
		}
		$api.byId("guide").style.display=s?"block":"none";
	}
	
	function initHistory(){
		var arr = getHistoryArr();
		if(arr.length==0){
			$api.byId("history").style.display="none";
        	return;
		}
		var list = [];
		for(var i=0;i<arr.length;i++){
			list.push(arr[i])
		}
		var content = $api.byId("history_content");
		var tpl = $api.byId("history_template").text;
		var tempFn = doT.template(tpl);
		content.innerHTML=tempFn(list)
	}
	function searchByKey(keyword){
		window.key=keyword
		var arr = getHistoryArr();
		var list = [];
		for(var i=0;i<arr.length;i++){
			if(keyword!=arr[i]){
				list.push(arr[i])
			}
		}
		list.unshift(keyword);
		var str ="";
		for(var i=0;i<list.length;i++){
			str +=",";
			str +=list[i];
		}
		api.setPrefs({
	        key:'discover_search_history',
	        value:str
        });
        api.execScript({
        	name:'search',
	        script: "setInput('"+keyword+"');"
        });
        //goSearch
        handleGuide(false)
        api.showProgress();
		getCoursesList(keyword);
	}
	
	function getCoursesList(keyword){
		var lat = api.getPrefs({sync:true,key:"latitude"});
		var lon = api.getPrefs({sync:true,key:"longitude"});
		api.showProgress();
		var body={};
		body.method="foundCoursePage"
		body.request={
			"userId":api.getPrefs({sync:true,key:"userid"}),
			"latitude": lat,
			"longitude": lon,
			"key": window.key
		}
		ajaxRequest(body,function(ret,err){
			api.hideProgress();
			api.refreshHeaderLoadDone();
			console.log(JSON.stringify(ret))
			if(ret){
				if(ret.responseCode==0){
					if(!ret.responseBody||ret.responseBody.length==0){
						showEmpty("附近没有任何课程",0);
					}else{
						$api.byId("empty").style.display="none"
						$api.byId("main").style.display="block"
						window.courseList=(ret.responseBody)
						fillData(ret.responseBody);
					}
				}else{
					showEmpty(ret.responseMsg);
				}
			}else{
				showEmpty(err.msg);
			}
		})
	}
	function fillData(ret){
		getInnerByDot("discover_content","discover_template",ret)
	}
	
	function goDetail(index,classid,courseid){
		var pageParam = {
			classId : classid,
			courseId : courseid,
			courseInfo : window.courseList[index]
		}
		openWin("coursedetail","",pageParam)
	}
	
	function showEmpty(msg,type){
		$api.byId("empty").style.display="block"
		$api.byId("main").style.display="none"
		$api.dom(".errmsg").innerHTML=msg;
		if(type==0){
			$api.dom(".errnet").style.background="url(../../image/icon_empty.png) no-repeat center bottom "
			$api.dom(".errnet").style.backgroundSize="2.18rem 2.18rem";
		}else{
			$api.dom(".errnet").style.background="url(../../image/icon_net_err.png) no-repeat center bottom "
			$api.dom(".errnet").style.backgroundSize="2.5rem 2.5rem";
		}
	}
	
	function tryAgain(){
		getCoursesList();
	}
	
	
	function getHistoryStr(){
		var discover_search_history = api.getPrefs({
	        sync:true,
	        key:'discover_search_history'
        });
        return discover_search_history;
	}
	
	function getHistoryArr(){
		var str = getHistoryStr();
		if(str){
			str = str.substring(1)
			if(str){
				return str.split(",")
			}else{
				return [];
			}
		}else{
			return [];
		}
		
	}
	
	function isInteger(x) {
	    return x % 1 === 0;
	}
	
</script>
</html>