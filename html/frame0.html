<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
	<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
	<title>title</title>
	<link rel="stylesheet" type="text/css" href="../css/api.css" />
	<link rel="stylesheet" type="text/css" href="../css/aui.css" />
	<link rel="stylesheet" type="text/css" href="../css/style.css" />
	<link rel="stylesheet" type="text/css" href="../css/swiper.min.css" />
	<style>
		body {
			background: #F6F6F6;
			font-size: 0.26rem;
			width: 100%;
		}

		header {
			width: 100%;
			top: 0px;
			position: fixed;
			z-index: 100;
			/*background: url(../image/divider_vertical.png);*/
			background: -webkit-linear-gradient(top, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.1))
		}

		#loc {
			background: url(../image/icon_loc.png) no-repeat 0.23rem center;
			background-size: 0.25rem;
			line-height: 0.88rem;
			height: 0.88rem;
			/*width:1.18rem;*/
			padding-left: 0.57rem;
			color: #FFF;
			float: left;
			font-size: 0.26rem;
		}

		.ellipsis-1 {
			display: -webkit-box;
			-webkit-line-clamp: 1;
			-webkit-box-orient: vertical;
			overflow: hidden;
			text-overflow: ellipsis;
			word-wrap: break-word;
			white-space: normal !important;
		}

		#loc.active {
			background: url(../image/icon_loc.png) no-repeat 0.23rem center rgba(0, 0, 0, 0.3);
			background-size: 0.25rem;
		}

		#search {
			display: inline-block;
			height: 0.5rem;
			width: 4.62rem;
			margin-left: 0.27rem;
			margin-top: 0.19rem;
			border-radius: 0.05rem;
			background: url(../image/icon_search.png) no-repeat 0.1rem center #FFF;
			background-size: 0.26rem 0.26rem;
		}

		#ring {
			float: right;
			position: relative;
			width: 0.88rem;
			height: 0.88rem;
		}

		#ring a {
			width: 0.88rem;
			height: 0.88rem;
		}

		#ring a.active {
			background: rgba(0, 0, 0, 0.3) !important;
		}

		header img {
			width: 0.35rem;
			height: 0.35rem;
			margin-top: 0.28rem;
			margin-left: 0.22rem;
		}

		.badge {
			display: none;
			padding: 2px 5px;
			float: left;
			position: absolute;
			margin-top: 0.1rem;
			left: 0.35rem;
			top: 0.05rem;
			font-size: 0.22rem;
			line-height: 1;
			color: #fff;
			background-color: #dd524d;
			border-radius: 10px;
		}
		/*
			 * Banner  begin
			 */

		#banner {
			width: 100%;
			height: 4.35rem;
		}

		#banner-content img {
			width: 100%;
			height: 4.35rem;
		}
		/**
			 * 功能
			 */

		#fun {
			width: 100%;
			height: 2.09rem;
			position: relative;
			background: #FFFFFF;
		}

		#fun:after {
			border-bottom: 1px solid #c1c1c1;
			display: block;
			content: '';
			position: absolute;
			top: 2.09rem;
			right: 0;
			bottom: 0;
			left: 0;
			pointer-events: none;
			-webkit-transform-origin: 0 0;
			-webkit-transform: scaleY(0.5);
		}

		#fun li {
			float: left;
			width: 20%;
			height: 2.09rem;
			text-align: center;
		}

		#fun li.active {
			height: 2.09rem;
			background: rgba(0, 0, 0, 0.2);
		}

		#fun li img {
			width: 1rem;
			height: 1rem;
			margin-top: 0.3rem;
		}

		#fun a {
			color: #2c2c2c;
			font-size: 0.28rem;
		}
		/**
			 * 新闻
			 */

		#news_content {
			width: 100%;
			margin-top: 0.26rem;
			height: auto;
		}

		.listview {
			position: relative;
			padding-left: 0;
			background-color: #fff;
			/*height:1.6rem;*/
		}

		.listview.active {
			background-color: #F9F9F9;
		}

		.listview:after {
			border-top: 1px solid #c1c1c1;
			display: block;
			content: '';
			position: absolute;
			top: 0;
			right: 0;
			bottom: 0;
			left: 0;
			transform-origin: 0 0;
			transform: scaleY(0.5);
			-webkit-transform-origin: 0 0;
			-webkit-transform: scaleY(0.5);
			pointer-events: none;
		}

		.listview-cell {
			position: relative;
			padding: 0.32rem 0.23rem;
			overflow: hidden;
			-webkit-transform-style: preserve-3d;
			transform-style: preserve-3d;
			-webkit-touch-callout: none;
		}

		.listview .list-img,
		.listview .list-img-body {
			overflow: hidden;
		}

		.list-img-body {
			/*color:#333333;
				font-size:0.28rem;*/
		}

		.list-img-title {
			color: #333333;
			font-size: 0.32rem;
			/*line-height:1.3;*/
		}

		.listview .list-img-object {
			width: 1.3rem;
			height: 1.04rem;
		}

		.listview .list-img-object.list-pull-left {
			margin-right: 0.21rem;
		}

		.list-pull-left {
			float: left !important;
		}

		.list-ellipsis-2 {
			display: -webkit-box;
			-webkit-line-clamp: 2;
			-webkit-box-orient: vertical;
			overflow: hidden;
			text-overflow: ellipsis;
			word-wrap: break-word;
			white-space: normal !important;
			text-indent: 1em;
			color: #666666;
			font-size: 0.26rem;
		}

		#sign {
			position: absolute;
			z-index: 10;
			top: 2rem;
			background: #fff;
			width: 1rem;
			height: 1rem;
			line-height: 1rem;
			text-align: left;
			border-radius: 0.5rem;
			color: #FF8344;
			right: -0.5rem;
		}
	</style>
</head>

<body>
	<!-- <div style="overflow: hidden;position: absolute;height:4.35rem;width:100%;">
		<div id="sign" onclick="openWindow('signin','')">签到</div>
		</div> -->
	<script type="text/x-dot-template" id="banner-template">
		{{ for(var i=0;i
		<it.length;i++){ }} <div class="swiper-slide" onclick="openBannerDetail('{{=it[i].id}}')">
			<img src="{{=$api.imageUrl+it[i].newsBanner}}" />
			</div>
			{{ } }}
	</script>
	<div class="swiper-container" id="banner">
		<div id="banner-content" class="swiper-wrapper">
		</div>
		<!-- 如果需要分页器 -->
		<div class="swiper-pagination"></div>
	</div>
	<div id="fun">
		<ul>
			<li tapmode="active" onclick="openWindow('mylesson','mine/mylesson')"><img src="../image/icon_courses.png" /><a>课程</a>
			</li>
			<!-- <li  tapmode="active" onclick="openWindow('homework','homework')"><img src="../image/icon_homework.png"/><a>作业</a>
				</li> -->
			<li tapmode="active" onclick="openWindow('task_win','homework')"><img src="../image/icon_homework.png" /><a>作业</a>
			</li>
			<li tapmode="active" onclick="openWindow('leave','leave')"><img src="../image/icon_askleave.png" /><a>请假</a>
			</li>
			<li tapmode="active" onclick="openScanner()"><img src="../image/icon_scan.png" /><a>扫一扫</a>
			</li>
			<li tapmode="active" onclick="openWindow('childSelect','home')"><img src="../image/icon_classroom.png" /><a>教材</a>
			</li>
		</ul>
	</div>
	<script id="news_template" type="text/x-dot-template">
		{{ for(var i=0; i
		< it.length; i++) { }} <div class="listview" tapmode="active">
			<div class="listview-cell list-img" onclick="openNewsDetail('{{=it[i].recommendId}}')">
				<img class="list-img-object list-pull-left" src="{{=$api.imageUrl+it[i].recommendImage}}">
				<div class="list-img-body">
					<h3 class="list-img-title">{{=it[i].recommendTitle}}</h3>
					<p class="list-ellipsis-2">
						{{=it[i].recommendIntro}}
					</p>
				</div>
			</div>
			</div>
			{{ } }}
	</script>
	<div id="news_content"></div>
	<header id="header">
		<!---->
		<div>
			<div class="ellipsis-1" onclick="openWin('location','home')" tapmode="active" id="loc">未知</div>
		</div>
		<div style="display: none" onclick="openSearch()" id="search"></div>
		<div id="ring">
			<a onclick="openMessage()" tapmode="active"><img src="../image/icon_ring.png" alt="" /><span class="badge">0</span></a>
		</div>
	</header>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/common.js"></script>
<script type="text/javascript" src="../script/doT.js"></script>
<script type="text/javascript" src="../script/swiper.min.js"></script>
<script type="text/javascript">
	goTask = function() {
		api.openWin({
			name: 'task_win',
			url: './homework/task_win.html',
			pageParam: {
				name: 'test'
			}
		});
	}

	function openDialog(count) {
		api.openFrame({
			name: 'dialog_sign',
			url: 'home/dialog_sign.html',
			animation: {
				type: "push", //动画类型（详见动画类型常量）
				subType: "from_top", //动画子类型（详见动画子类型常量）
				duration: 300 //动画过渡时间，默认300毫秒
			},
			pageParam: {
				signCount: count
			},
			rect: {
				x: 0,
				y: 0,
				w: api.winWidth,
				h: api.winHeight
			}
		});
	}

	function openScanner() {
		var obj = api.require('FNScanner');
		obj.openScanner({
			sound: 'widget://res/beep.wav',
			autorotation: true,
			saveToAlbum: false,
			saveImg: {
				path: '',
				w: 300,
				h: 300
			}
		}, function(ret, url) {
			//alert(JSON.stringify(ret))
			if (ret.eventType == "success") {
				api.openWin({
					name: 'scan',
					url: './mine/FNscanner.html',
					pageParam: {
						url: ret.content
					},
					rect: {
						x: 0,
						y: 0,
						w: 'auto',
						h: 'auto'
					},
					bounces: false,
					showProgress: true
				});

			}

		});
	}

	function openMessage() {
		var userid = api.getPrefs({
			sync: true,
			key: 'userid'
		})
		var frameInfo = {
			name: 'message_list',
			url: 'home/message_list.html',
		}
		if (!userid) {
			api.openWin({
				name: 'login',
				url: 'login.html',
				pageParam: {
					name: "title_messageList",
					url: "消息",
					frameInfo: frameInfo
				}
			});
			return;
		}
		openWinWithTitle("title_messageList", "消息", frameInfo);
	}

	function openWindow(name, url) {
		var userid = api.getPrefs({
			sync: true,
			key: 'userid'
		})
		if (!userid) {
			api.openWin({
				name: 'login',
				url: 'login.html',
				pageParam: {
					name: name,
					url: url
				}
			});
			return;
		}
		openWin(name, url)
	}
	checkKid=function(){
		//***************注册成功后跳到关联孩子的页面*0925******************************************************
		var userid = Number(api.getPrefs({
			sync: true,
			key: 'userid'
		}));
		goRequest("getStudentsByUserId",{"userId": userid},function(ret){
					studentCount= new Array();
					for (var i = 0; i < ret.responseBody.length; i++) {
						studentCount.push(ret.responseBody);
					}
					api.setPrefs({
						key: 'studentCount',
						value: studentCount
					});
					if(studentCount.length<1){
						api.openWin({
								name: 'bindChild',
								url: './mine/bindChild.html',
								pageParam:{
									tag:"fristLogin"
								}
						});
						return;
					}
		})
	}

	var badge;
	var viewInited = false;
	imready = function() {
		//初始化Banner
		initBanner();
		//初始化新闻List
		initList();
		var userid = api.getPrefs({
			sync: true,
			key: "userid"
		});
		// signOrNot();

		// ****************0926取消签到*******************
		// signOrNot();
		api.getPrefs({
			sync: false,
			key: 'currentLocation'
		}, function(ret, err) {
			if (ret.value) {
				$api.byId("loc").innerHTML = ret.value;
			} else {
				//定位
			}
		});
		viewInited = true;
		api.addEventListener({
			name: 'locationChanged'
		}, function(ret, err) {
			locationChanged();
		});
		badge = $api.dom(".badge")
		
		var fs = api.require('fs');
		fs.exist({
			path: api.fsDir + '/default/' + 'hardicon.png'
		}, function(ret, err) {
			if (ret.exist) {
				console.log("已存在")
			} else {
				fs.copyTo({
					oldPath: 'widget://image/mine/hardicon.png',
					newPath: api.fsDir + '/default/'
				}, function(ret, err) {

				});
			}
		});
		if (!userid) {
			return;
		}else{
			checkKid();
		}
		requestMessageList();
		api.addEventListener({
			name: 'viewappear'
		}, function(ret, err) {
			requestMessageList();
		});
	};

	function locationChanged() {
		if (viewInited) {
			initBanner();
			initList();
			updateLocation();
		} else {
			setTimeout("locationChanged();", 1000);
		}
	}

	function requestMessageList() {
		var userId = api.getPrefs({
			sync: true,
			key: "userid"
		});
		if (!userId) {
			return;
		}
		var body = {
			"method": "readShowVerify",
			"request": {
				"scopeType": 1, //1用户
				"messageReceiverId": userId
			}
		}
		ajaxRequest(body, function(ret, err) {
			console.log(JSON.stringify(ret))
			if (ret) {
				if (ret.responseCode == 0) {
					if (ret.responseBody) { //有
						badge.style.display = "block"
						badge.innerHTML = ret.responseBody
					} else { //无
						badge.style.display = "none"
					}
				} else {}
			} else {}
		})
	}

	var bCount = 0;

	function initBanner() {
		api.readFile({
			sync: false,
			path: 'widget://res/banner-min.json'
		}, function(ret, err) {
			if (ret.status) {
				getInnerByDot("banner-content", "banner-template", $api.strToJson(ret.data).responseBody)
			}
		});
		api.showProgress();
		var lon = api.getPrefs({
			sync: true,
			key: "longitude"
		})
		var lat = api.getPrefs({
			sync: true,
			key: "latitude"
		})
		if (!lon && !lat) {
			//				bCount++;
			//				if(bCount<10){
			//					setTimeout("initBanner()",1000)
			//					console.log("暂无位置信息")
			//				}else{
			api.setPrefs({
				key: 'longitude',
				value: "0"
			});
			api.setPrefs({
				key: 'latitude',
				value: "0"
			});
			api.showProgress();
			setTimeout("initBanner()", 1000)
				//					toastAtMiddle("请开启定位后重试")
				//				}
				//				return ;
		}
		var bodyParam = {};
		var request = {
			userId: api.getPrefs({
				sync: true,
				key: 'userid'
			}),
			longitude: lon,
			latitude: lat
		}
		var method = "getValidBannerNewsList"
		bodyParam.request = request;
		bodyParam.method = method;
		ajaxRequest(bodyParam, function(ret, err) {
			api.hideProgress();
			if (ret) {
				//alert("成功"+JSON.stringify(ret))
				if (ret.responseCode == 0) {
					var list = ret.responseBody;
					window.sliderLength = list.length;
					getInnerByDot("banner-content", "banner-template", list)
					initSlider();
				} else {
					//alert(ret.responseMsg)
				}
			} else {
				alert(ret.err)
			}
		});
	}
	var mySwiper;

	function initSlider() {
		if (mySwiper) {
			mySwiper.destroy();
			//				return;
		}
		mySwiper = new Swiper('.swiper-container', {
			direction: 'horizontal',
			loop: true,
			autoplay: 3000,
			autoplayDisableOnInteraction: false,
			// 如果需要分页器
			pagination: '.swiper-pagination',
			paginationBulletRender: function(swiper, index, className) {
				return '<span style="background:#FF8344" class="' + className + '"></span>';
			}
		})

		//			var banner = $api.byId("banner");
		//			window.mySlide = Swipe(banner, {
		//				auto : 3000,
		//				continuous : true,
		//				disableScroll : true,
		//				stopPropagation : true,
		//				callback : function(index, element) {
		//					index = index%window.sliderLength
		//					var lis = $api.domAll("#banner li");
		//					var last = $api.dom(".current");
		//					$api.removeCls(last, "current");
		//					$api.addCls(lis[index], "current");
		//				},
		//				transitionEnd : function(index, element) {
		//				}
		//			});
	}
	var lCount = 0;

	function initList() {
		api.readFile({
			sync: false,
			path: 'widget://res/recommend-min.json'
		}, function(ret, err) {
			if (ret.status) {
				getInnerByDot("news_content", "news_template", $api.strToJson(ret.data).responseBody)
			}
		});
		api.showProgress();
		var lon = api.getPrefs({
			sync: true,
			key: "longitude"
		})
		var lat = api.getPrefs({
			sync: true,
			key: "latitude"
		})
		if (!lon && !lat) {
			lCount++;
			if (lCount < 10) {
				setTimeout("initList()", 1000)
				console.log("暂无位置信息")
			} else {
				api.setPrefs({
					key: 'longitude',
					value: "0"
				});
				api.setPrefs({
					key: 'latitude',
					value: "0"
				});
				api.hideProgress();
				setTimeout("initList()", 1000)
				toastAtMiddle("请开启定位后重试")
			}
			return;
		}
		var body = {};
		body.method = "getRecommendedDatas";
		body.request = {
			userId: api.getPrefs({
				sync: true,
				key: "userid"
			}),
			longitude: lon,
			latitude: lat
		}
		ajaxRequest(body, function(ret, err) {
			api.hideProgress();
			if (ret) {
				if (ret.responseCode == 0) {
					getInnerByDot("news_content", "news_template", ret.responseBody)
				} else {
					//alert(ret.responseMsg)
				}
			} else {
				alert(err.msg)
			}
		})
	}

	function signOrNot() {
		var userid = api.getPrefs({
			sync: true,
			key: "userid"
		});
		if (!userid) {
			return;
		}
		var date = new Date();
		var today = (date.getMonth() + 1) + "_" + date.getDate();
		var isSign = api.getPrefs({
			sync: true,
			key: "sign_" + today + "_" + userid
		});
		if (isSign) {} else {
			requestSignUp(userid);
		}
	}

	/**
	 * 请求签到接口
	 */
	function requestSignUp(userid) {
		var body = {
			"method": "addUserSign",
			"request": {
				"userId": userid
			}
		}
		ajaxRequest(body, function(ret, err) {
			if (ret) {
				if (ret.responseCode == 0) {
					if (ret.responseBody) { //今天第一次签到
						var date = new Date();
						var today = (date.getMonth() + 1) + "_" + date.getDate();
						api.setPrefs({
							key: "sign_" + today + "_" + userid,
							value: "isSign"
						});
						requestSignCount();
					}
				} else {
					toastAtMiddle("签到失败!" + ret.responseMsg + "!请稍后重试")
				}
			} else {
				//签到失败,需要下一次进行签到//
				toastAtMiddle("签到失败!" + err.msg + "!请稍后重试")
			}
		})
	}

	function requestSignCount() {
		var body = {
			"method": "getUserSignByUserId",
			"request": {
				"userId": api.getPrefs({
					sync: true,
					key: "userid"
				})
			}
		}
		ajaxRequest(body, function(ret, err) {
			api.hideProgress();
			if (ret) {
				if (ret.responseCode == 0) {
					openDialog(ret.responseBody.continueCount);
				} else {
					openDialog(0);
				}
			} else {
				openDialog(0);
			}
		})
	}

	function updateLocation() {
		var value = api.getPrefs({
			sync: true,
			key: 'currentLocation'
		});
		if (value.length > 3) {
			$api.byId("search").style.width = '4.4rem'
		} else {
			$api.byId("search").style.width = '4.62rem'
		}
		$api.byId("loc").innerHTML = value;
	}

	function openBannerDetail(id) {
		openNewsDetail(id)
	}

	function openNewsDetail(id) {
		if (!id || id == 'null')
			return alert("新闻id为" + id);
		var frameInfo = {
			name: 'news_detail',
			url: 'home/news_detail.html',
			pageParam: {
				id: id
			}
		}
		openWinWithTitle("title_news", "资讯详情", frameInfo)
	}

	function openSearch() {
		api.openWin({
			name: "search",
			url: 'home/search.html',
			opaque: true,
			vScrollBarEnabled: false,
			animation: {
				type: "fade", //动画类型（详见动画类型常量）
				duration: 300 //动画过渡时间，默认300毫秒
			},
			pageParam: {
				from: "index"
			}
		});
	}
</script>

</html>
